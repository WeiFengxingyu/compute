# 实验步骤记录（详细易懂版）

本文件用于记录每次实验的完整过程，帮助初学者快速理解“如何运行、涉及到哪些文件、背后的原理”，并保证可复现与审计。
 
## 0. 问题建模（输入/输出/目标与约束）

本项目解决“离散时段的多产线多产品生产调度”问题：在给定订单与生产配置的前提下，决定每条产线在每个4小时时段生产哪种产品及产量分配，以最大化企业利润，同时尽量保证订单按期完成。

- 输入数据（文件与字段）
  - `data/config.json`：生产配置
    - `lines`：产线数量（如3）
    - `products`：产品列表，含 `id`、`rate_per_hour`（件/小时）、`unit_cost`（单位生产成本）
    - `wage_per_slot_per_line`：每条产线每时段基础工资
    - `wage_multiplier_per_slot`：6个时段的工资系数数组（如 `[1.0,1.1,1.2,1.35,1.5,1.3]`）
    - `allow_idle`：是否允许空闲（节省高工资时段成本）
  - `data/orders.json`：订单集合
    - 每条订单包含：`id`、`product`（产品ID）、`qty`（总量）、`unit_price`（单价）、`arrival_day`（到达日，8点后到达则次日排程）、`due_day`（截止日，截止日早上8点）
  - 运行参数（CLI）：`--horizon`（计划天数）、`--generations`、`--pop`、`--pc`、`--pm` 等算法参数

- 输出数据（运行记录与指标）
  - 目录：`experiments/run-YYYYMMDD_HHMMSS_<tag>_seed<SEED>/`
    - `config.json`、`orders.json`：本次运行的输入快照
    - `schedule.json`：调度方案（每时段每线生产的产品或空闲）
    - `metrics.json`：指标，包括：
      - `profit`、`total_revenue`、`production_cost`、`wage_cost`、`penalty`
      - `utilization_rate`（产线利用率）、`on_time_rate`（准时率）、`penalty_rate`（罚金触发率）
    - `summary.md`：关键指标与主要配置片段摘要
  - 批量汇总：`experiments/batch_<exp_tag>_summary.csv`

- 约束条件与假设（与任务书一致）
  - 三条产线能力相同；每4小时为一个离散时段；产品切换仅在时段边界发生
  - 工资按时段结算，越偏离正常工作时间工资越高
  - 原材料无限；资源与管理费用包含在生产成本中；工人能力一致
  - 每天8点统一排程；8点后到达的订单次日安排；截止时间为截止日8点
  - 同产品订单的“最后不足4小时”可在一个时段合并加工（不超过容量）

- 目标函数（用于适应度评估）
  - 最大化利润：`Profit = Revenue - ProdCost - WageCost - Penalty`
  - 其中：
    - 收入 `Revenue = Σ(delivered_k * unit_price_k)`
    - 生产成本 `ProdCost = Σ(产量 * unit_cost_product)`
    - 工资成本 `WageCost = Σ(时段基础工资 * 时段系数 * 实际生产线数)`
    - 罚金 `Penalty = Σ(未按期完整交付的订单金额 * 10%)`

- 关键符号（直觉化理解）
  - `slot`：一天的6个时段之一；`line`：某条产线；`product`：产品ID
  - `x_{line,slot,product}`：该线在该时段生产该产品的件数（离散件数，0..容量）
  - `schedule`：所有 `slot×line` 的产品选择与产量分配的集合
  - `delivered_k`：订单k在其截止前累计交付件数，用于收入与罚金判定

---

## 0.5 步骤补录（M0 与 M1 前期）

为保证记录完整性，补录此前未写入本文件的步骤（按实施计划与实际留痕）。每一步均包含“目的/涉及文件/示例命令/验收标准”。

1) M0-1 仓库结构初始化
- 目的：创建基础目录，规范后续代码与实验留痕
- 涉及文件/目录：`src/`, `data/`, `results/`, `experiments/`
- 示例命令：无（结构创建），后续通过 `python -m src.main` 验证
- 验收：目录存在且权限正常

2) M0-2 配置与订单样例
- 目的：提供最小可运行数据集，便于功能通路验证
- 涉及文件：`data/config.json`, `data/orders.json`
- 示例命令：见下方“操作与复现步骤”中的单次运行；或：
  - `python -m src.main --horizon 7 --generations 40 --pop 40 --pc 0.8 --pm 0.08 --config data/config.json --orders data/orders.json --out results --runs_dir experiments --exp_tag baseline-ga --seed 123`
- 验收：生成 `experiments/run-...` 目录，`metrics.json` 与 `summary.md` 正常

3) M0-3 CLI入口打通
- 目的：确保 `python -m src.main` 能读取配置与订单并完成一次完整运行
- 涉及文件：`src/main.py`
- 示例命令：同上
- 验收：控制台输出关键指标，目录与文件按规范落盘

4) M0-4 实验运行记录器
- 目的：将输入、输出与指标自动归档到 `experiments/run-...` 目录
- 涉及文件：`src/utils/run_logger.py`
- 验收：目录包含 `config.json/orders.json/schedule.json/metrics.json/summary.md`

5) M1-1 模型与实体定义
- 目的：抽象订单、产线、时段、产品与配置，作为算法与解码的基础
- 涉及文件：`src/models/entities.py`
- 验收：实体可被 `main` 与算法/解码器正确引用

6) M1-2 解码器（EDD + 利润密度）
- 目的：将染色体方案解读为订单内的具体分配，优先满足到期早的订单；同到期按利润密度分配
- 涉及文件：`src/decoders/edd_decoder.py`
- 验收：生成的 `schedule.json` 与订单分配合理，无越期分配（若策略允许空闲则不强制完成）

7) M1-3 适应度评估
- 目的：计算收入、生产成本、工资成本与罚金，并导出核心指标
- 涉及文件：`src/evaluation/fitness.py`
- 输出字段：`profit,total_revenue,production_cost,wage_cost,penalty,utilization_rate,on_time_rate,penalty_rate`
- 验收：指标在 `metrics.json` 正确落盘，`summary.md` 显示关键指标

8) M1-4 基线 GA 可运行
- 目的：实现选择/交叉/变异与精英保留，输出最优或最新方案
- 涉及文件：`src/algorithms/ga.py`, `src/main.py`
- 示例命令：`python -m src.main --horizon 30 --generations 100 --pop 60 --pc 0.9 --pm 0.1 --config data/config.json --orders data/orders.json --out results --runs_dir experiments --exp_tag baseline-ga --seed 123`

---

## M6 阶段2.1：软截止引导参数消融（h14 vs h30）

- 目的：评估软截止引导窗口长度（h=14 vs h=30）对利润、利用率、准时率、罚金触发率的影响。
- 数据来源：
  - `experiments/batch_ga-vns-soft-h14_summary.csv`（当前 seeds 404–406）
  - `experiments/batch_ga-vns-soft-h30_summary.csv`（当前 seeds 404–406）
- 绘图脚本：`experiments/scripts/plot_soft_ablation_figures.py`
  - 输出到 `paper/figures/`：
    - `m6s2_soft_profit_bars.png`
    - `m6s2_soft_utilization_rate_bars.png`
    - `m6s2_soft_on_time_rate_bars.png`
    - `m6s2_soft_penalty_rate_bars.png`
- 统计摘要（均值±标准差；当前 3 次）：
  - 利润：h14 = `-91816.67 ± 6833.28`，h30 = `-673410.00 ± 11523.96`
  - 利用率：h14 = `0.4735 ± 0.0092`，h30 = `0.5012 ± 0.0047`
  - 准时率：两者均为 `0.0000 ± 0.0000`
  - 罚金触发率：两者均为 `1.0000 ± 0.0000`
- 结论与建议：
  - h14 相较 h30 显著降低工资成本带来的利润损失；
  - h30虽提升利用率，但在当前工资模型下不可取；
  - 软截止单独启用未改善准时率与罚金触发，需要配合提高截止权重或软罚项系数、或调整订单紧迫度分布；
- 下一步：扩充种子至 `500–509`（各10次），补充统计检验（配对 t / Wilcoxon）。
- 验收：`experiments/run-...` 目录完整，`profit`、`on_time_rate` 等指标可计算

注：批量运行器 `src/experiments/runner.py` 属于后续批量实验（计划M6），我们已提前实现用于验证与统计，其参数会自动映射到 `src.main` 的短旗标。

## 1. 目标与结论快照
- 目标：完成 M1 基线 GA 的“300 代长跑收敛验证”，使用 5 个不同 `seed`，并汇总指标的均值与标准差。
- 本次结论（汇总自 `experiments/batch_baseline-ga-longrun_summary.csv`）：
  - `profit` 平均值 `-1168422.00`，标准差 `8788.63`
  - `on_time_rate` 平均值 `0.05`，标准差 `0.06`
  - `utilization_rate` 平均值 `0.73`，标准差 `0.01`
  - `penalty_rate` 平均值 `0.95`，标准差 `0.06`
  - 收入 `total_revenue` 稳定为 `408300.00`（所有运行一致），成本与工资有小幅波动

> 说明（详细）：
> - 基线 GA 未包含“可行性修复器（避免夜间高工资盲目生产）”与“结构更强的交叉/变异”，导致在高工资夜间时段仍有较多活跃，`wage_cost（工资成本）`显著抬升；
> - 解码器采用 EDD+利润密度分配，但未对“截止前全部完成”施加强软约束或硬修复，订单集中时很容易触发`penalty（罚金）`；
> - 数据集的`total_revenue（总收入）`接近常数（≈ 408300），延后完成虽记收入但不免罚金，难以抵消`wage_cost（工资成本）`与`production_cost（生产成本）`的合计；
> - 因此在 M1 阶段负利润是合理的阶段性现象；M2 针对“夜间降活跃+窗口交叉+分层变异+修复器”已使`wage_cost（工资成本）`与`profit（利润）`明显收敛；M3 将通过 VNS/ILS 的邻域微调，进一步提升`on_time_rate（准时率）`、降低`penalty（罚金）`，推动`profit（利润）`向非负或转正。

## 2. 涉及文件与原理简介
- `src/main.py`：命令行入口。负责加载配置与订单、执行 GA、打印与保存结果，并调用实验记录工具保存 `config.json`、`orders.json`、`schedule.json`、`metrics.json`、`summary.md`。
- `src/algorithms/ga.py`：遗传算法基线实现。
  - 编码：调度表 `Schedule`（每个时段、每条产线对应生产的产品ID或空闲），以列表/矩阵形式表示。
  - 选择：锦标赛选择（随机抽样比较适应度）。
  - 交叉：按“天”为边界的块交叉（后续 M2 将增强为窗口交叉）。
  - 变异：随机扰动产线安排（后续 M2 将分层与比例化）。
  - 精英保留：保留当前最优个体。
- `src/decoders/edd_decoder.py`：解码策略（EDD：最早到期优先），将染色体/方案转成具体的时段安排；当前策略偏向“尽早生产满足订单”，后续可加入利润密度权重。
- `src/evaluation/fitness.py`：评估指标计算。
  - 收入 `total_revenue` = 完成数量 × 单价；
  - 生产成本 `production_cost` = 完成数量 × 单位成本；
  - 工资 `wage_cost` = 每时段每线工资 × 工资系数（不同时段系数不同）；
  - 罚金 `penalty` = 超期或未完成触发罚金；
  - 利润 `profit` = 收入 − 成本 − 工资 − 罚金；并计算 `utilization_rate`、`on_time_rate`、`penalty_rate`。
- `src/utils/run_logger.py`：实验记录工具。为每次运行创建 `experiments/run-YYYYMMDD_HHMMSS_<tag>_seed<SEED>/` 并保存上述 JSON 与 `summary.md`。
- `src/experiments/runner.py`：批量实验运行器。支持 `--seed-start/--seed-end` 或 `--seeds`，重复调用 `src.main` 并将 `metrics` 聚合到 CSV。
- `data/config.json`：示例配置（产线数、产品产能成本、工资与系数等）。
- `data/orders.json`：示例订单（产品、数量、到达与截止）。
- `results/latest_schedule.json`：最近一次运行的调度与指标快照（非分批，单次运行）。

## 3. 操作与复现步骤（可直接照做）
1) 批量运行 M1 长跑验证（5 次）：
```
python -m src.experiments.runner \
  --exp_tag baseline-ga-longrun \
  --seed-start 101 --seed-end 105 \
  --horizon 30 \
  --generations 300 \
  --population 80 \
  --crossover 0.9 \
  --mutation 0.1 \
  --config data/config.json \
  --orders data/orders.json \
  --outdir results \
  --runs_dir experiments
```
2) 查看汇总 CSV：`experiments/batch_baseline-ga-longrun_summary.csv`
3) 打开任意一次运行目录，例如：
   - `experiments/run-20251101_112215_baseline-ga-longrun_seed101`
   - 文件说明：
     - `config.json`：本次配置；`orders.json`：本次订单；
     - `schedule.json`：调度表（每时段每线的产品ID或空闲`null`）；
     - `metrics.json`：指标明细；
     - `summary.md`：关键指标与主要配置片段摘要。
4) 如需单次运行（非批量），可使用：
```
python -m src.main \
  --horizon 30 \
  --generations 300 \
  --pop 80 \
  --pc 0.9 \
  --pm 0.1 \
  --config data/config.json \
  --orders data/orders.json \
  --out results \
  --runs_dir experiments \
  --exp_tag baseline-ga-longrun \
  --seed 123
```

## 4. 本次实验详细记录（M1：300代×5次）
- 运行命令：见“操作与复现步骤”第1项。
- 运行目录与关键指标：
  - seed=101 → `experiments/run-20251101_112215_baseline-ga-longrun_seed101`
    - `profit=-1177790.00`，`on_time_rate=0.125`，`utilization_rate=0.7444`，`penalty_rate=0.875`
  - seed=102 → `experiments/run-20251101_112229_baseline-ga-longrun_seed102`
    - `profit=-1155890.00`，`on_time_rate=0.125`，`utilization_rate=0.7222`，`penalty_rate=0.875`
  - seed=103 → `experiments/run-20251101_112244_baseline-ga-longrun_seed103`
    - `profit=-1169050.00`，`on_time_rate=0.000`，`utilization_rate=0.7315`，`penalty_rate=1.000`
  - seed=104 → `experiments/run-20251101_112300_baseline-ga-longrun_seed104`
    - `profit=-1177990.00`，`on_time_rate=0.000`，`utilization_rate=0.7333`，`penalty_rate=1.000`
  - seed=105 → `experiments/run-20251101_112316_baseline-ga-longrun_seed105`
    - `profit=-1161390.00`，`on_time_rate=0.000`，`utilization_rate=0.7259`，`penalty_rate=1.000`
- 汇总统计（均值±标准差）：
  - `profit（利润）`：`-1168422.00 ± 8788.63`
  - `on_time_rate（准时率）`：`0.05 ± 0.06`
  - `utilization_rate（产线利用率）`：`0.73 ± 0.01`
  - `penalty_rate（罚款触发率）`：`0.95 ± 0.06`
  - `total_revenue（总收入）`：`408300.00 ± 0.00`
  - `production_cost（生产成本）`：`556872.00 ± 3916.19`
  - `wage_cost（工资成本）`：`981220.00 ± 8540.59`
  - `penalty（罚金）`：`38630.00 ± 2694.44`

- M1 结论与总结（详细）：
  - 结构性原因：基线 GA 的“按天块交叉”和“随机变异”对结构继承与截止导向不足，解码器未施加强软约束，导致`penalty（罚金）`高、`on_time_rate（准时率）`低；
  - 成本构成：`wage_cost（工资成本）= 981220` 明显大于 `total_revenue（总收入）= 408300`，再加上 `production_cost（生产成本）= 556872` 与 `penalty（罚金）= 38630`，自然导致 `profit（利润）` 为负；
  - 行为特征：`utilization_rate（产线利用率）≈ 0.73`，说明整体活跃度较高且包含大量夜间活跃；同时 `penalty_rate（罚款触发率）≈ 0.95` 指示订单几乎都未按期全部完成；
  - 提升方向：在不改变收入上限的前提下，必须降低高工资时段的活跃（以降`wage_cost`），并将关键订单生产块滑移至更早且更低工资的时段（以提`on_time_rate`、降`penalty`）；这正是 M2/M3 的优化重点。

## 5. 常见问题与排错
- 入口参数名说明：
  - 单次运行 `src.main` 使用 `--pop --pc --pm --out`；
  - 批量运行 `runner` 中参数为 `--population --crossover --mutation --outdir`，已在内部映射到 `src.main` 的参数，不需要修改。
- 若未生成 `experiments/run-...` 目录：检查是否使用了正确的 `--runs_dir` 与 `--exp_tag`。
- 若指标为 `None`：说明某次运行失败或被中断，查看控制台报错并重试该 `seed`。

## 6. 下一步计划（指向 M2/M3）
- M2（GA增强）：实现“窗口交叉（2–3 时段）”“分层变异”“可行性修复器”，目标是降低 `wage_cost` 和 `penalty`、提升 `profit` 与 `on_time_rate`。
- M3（VNS/ILS）：设计邻域（同线相邻交换、跨线重分配、块滑移/合并/分裂），在 GA 之后进行若干轮局部搜索以进一步改善方案。
- 每次改动都以 `--exp_tag` 标注版本（如 `ga-v0.2-repair`），并将关键结果与算法说明同步到本文件与 `设计与实现方案.md`。

---

若你希望我将“三场景×30次”的批量脚本也加入（自动生成场景级 CSV 与均值/标准差），请告知，我会基于当前 `runner` 增加场景参数与并行支持。

## 7. M2 实验记录（GA增强：窗口交叉/分层变异/修复器）
- 目标：在基线 GA 上引入窗口交叉（2–3 时段）、分层变异（产品切换/空闲插入/同槽线间交换）、可行性修复器（夜间高工资时段的非紧急产能下调），验证对利润与工资成本的影响。
- 代码改动：
  - `src/algorithms/ga.py`：
    - 交叉 `crossover` 改为“窗口交叉”（长度2或3槽）；短计划视野仍回退到“按天块”交叉。
    - 变异 `mutate` 扩展为分层策略：产品翻转、空闲插入（若允许）、同槽随机线交换、夜间时段轻度降活跃（工资系数≥1.35）。
    - 修复器 `repair_schedule`：按产品的最早到期日，在工资系数高的槽（夜间/深夜）对非紧急产品以小概率转为空闲，避免无效高成本。
  - `src/main.py`：`metrics.json` 增加 `delivered_per_order` 字段，记录每个订单的最终交付件数（便于细致分析）。

- 批量运行命令：
```
python -m src.experiments.runner \
  --exp_tag ga-enhanced \
  --seed-start 201 --seed-end 205 \
  --horizon 30 \
  --generations 300 \
  --population 100 \
  --crossover 0.9 \
  --mutation 0.12 \
  --config data/config.json \
  --orders data/orders.json \
  --outdir results \
  --runs_dir experiments
```

- 数据落盘与目录：
  - 汇总文件：`experiments/batch_ga-enhanced_summary.csv`
  - 单次运行目录示例：`experiments/run-20251102_103136_ga-enhanced_seed201`（每次运行均含 `config.json`、`orders.json`、`schedule.json`、`metrics.json`、`summary.md`、`plots/`）。
  - 指标补充：`metrics.json` 现包含 `delivered_per_order`，可直接用于订单级收益/罚金分析。

- 汇总统计（均值±标准差，5个seed=201..205，选取各seed最新一条）：
  - `profit`（利润）：`-690194.00 ± 13149.21`
  - `wage_cost`（工资成本）：`663280.00 ± 7916.16`
  - `production_cost`（生产成本）：`394384.00 ± 6215.73`
  - `total_revenue`（总收入）：`408300.00 ± 0.00`
  - `penalty`（罚金）：`40830.00 ± 0.00`
  - `utilization_rate`（产线利用率）：`0.51 ± 0.00`
  - `on_time_rate`（准时率）：`0.00 ± 0.00`；`penalty_rate`（罚款触发率）：`1.00 ± 0.00`

- 结论与下一步：
  - 相比 M1，`profit` 明显提升（减少夜间高工资活跃、引入窗口交叉带来结构继承性），`wage_cost` 略降，`production_cost`略降；`utilization_rate`下降（更多夜间空闲）。
  - `on_time_rate` 暂未改善，说明仅靠 GA 的结构调整与夜间降活跃不足以满足到期约束；将按计划推进 M3（VNS/ILS）在 GA 后对方案做邻域微调（时段滑移、跨线重分配）以进一步降低罚金并提升准时率。

### 附加分析：为何近期利润仍为负、差距是否偏大（M1→M2）
- 数值拆解（以 M2 的均值为例）：
  - 利润 `profit ≈ 408300（总收入） - 394384（生产成本） - 663280（工资成本） - 40830（罚金） ≈ -689,766`。
  - 结论：工资成本与生产成本之和显著超过收入，再叠加罚金，导致利润为负。
- 原因详解：
  - 工资成本偏高：
    - 基础工资 `wage_per_slot_per_line=2000` 较高，夜间系数（如≥1.35）在高活跃时段会放大成本；
    - 视野 `30` 天共有 `180` 时段，虽然利用率约 `0.51`（产线利用率），但活跃线×时段累计仍较大，导致工资累加额显著。
  - 罚金触发率高：
    - `penalty_rate（罚款触发率）≈ 1.00`，说明订单几乎都未在截止前“全部完成”；
    - 解码器按 “EDD+利润密度” 分配产量，未结合“严格的到期硬约束”，在产能有限与订单集中时，难以同时满足所有订单的截止要求。
  - 收入上限固定：
    - 当前数据集 `total_revenue（总收入）≈ 408300`，在罚金规则（未按期全部完成罚10%）下，收入难以通过“延后完成”增长（延后仅计收入，不免罚），使利润提升受到限制。
- 与预期的差距：
  - 基线（M1）负利润在预期之内：因为尚未进行“避免高工资时段无效启动”和“结构化交叉/变异”的优化，工资与罚金都会偏高；
  - M2 的改进已显著降低工资成本（夜间降活跃）并改善利润，但由于尚未进行截止导向的邻域微调（M3），`on_time_rate（准时率）`仍为 `0`，罚金仍在；
  - 因此“仍为负”的结果并非异常，属于阶段性合理现象：在加入 M3（VNS/ILS）将生产块滑移至低工资且更靠近截止时间、并在跨线重分配后，预计罚金和工资将进一步下降，利润向非负逼近或转正。

### 指标名对照与阅读提示
- `profit（利润）`：综合目标，受收入、成本、工资与罚金共同影响；
- `on_time_rate（准时率）`：按期且“全部完成”的订单比例；
- `penalty_rate（罚款触发率）`：未按期或未完整交付的订单比例；
- `utilization_rate（产线利用率）`：活跃线×时段占总线×时段比例；
- `delivered_per_order（订单交付件数）`：用于逐单分析收益与罚金触发情况。

---

## 8. M3 实验记录（GA+VNS 局部搜索集成）

- 目标：在 GA 输出的最优解基础上引入 VNS（变邻域搜索），通过“小/中/大”邻域的微调提升利润、降低高工资时段活跃，并尽可能改善截止相关指标。
- 代码改动（对应 `设计与实现方案.md` 第 5 章与 5.6 节）：
  - 新增：`src/algorithms/vns.py`
    - 邻域1（小）：同线相邻时段交换（`_neighbor_swap_adjacent`）。
    - 邻域2（中）：跨线同槽重分配，偏向“最紧急产品”（`_neighbor_cross_line_reassign`）。
    - 邻域3（大）：块滑移到更低工资的更早槽（`_neighbor_block_shift`）。
    - 主过程：`vns_improve(schedule, config, orders, rounds, attempts)`，按“小→中→大”循环，找到改进立即接受。
  - 主程序接入：`src/main.py` 新增参数 `--local_search vns --ls_rounds --ls_attempts`，在 GA 后执行 VNS 并在控制台打印提升信息。
  - 批量 Runner：`src/experiments/runner.py` 新增 `--local_search/--ls_rounds/--ls_attempts` 并转发到主程序。

- 运行命令（单次示例，7 天视野、150 代）：
```
python -m src.main \
  --horizon 7 --generations 150 --pop 80 --pc 0.8 --pm 0.08 \
  --config data/config.json --orders data/orders.json --out results \
  --runs_dir experiments --exp_tag ga-vns --seed 404 \
  --local_search vns --ls_rounds 3 --ls_attempts 120
```

- 本次运行目录与关键指标（3 次不同种子）：
  - seed=404 → `experiments/run-20251110_144419_ga-vns_seed404`
    - `profit=3,110.00`，`total_revenue=333,200.00`，`production_cost=110,760.00`，`wage_cost=178,500.00`，`penalty=40,830.00`
    - `utilization_rate=0.579`，`on_time_rate=0.000`，`penalty_rate=1.000`
  - seed=405 → `experiments/run-20251110_144505_ga-vns_seed405`
    - `profit=4,970.00`，`total_revenue=359,600.00`，`production_cost=120,800.00`，`wage_cost=193,000.00`，`penalty=40,830.00`
    - `utilization_rate=0.627`，`on_time_rate=0.000`，`penalty_rate=1.000`
  - seed=406 → `experiments/run-20251110_144523_ga-vns_seed406`
    - `profit=5,370.00`，`total_revenue=335,360.00`，`production_cost=111,360.00`，`wage_cost=177,800.00`，`penalty=40,830.00`
    - `utilization_rate=0.579`，`on_time_rate=0.000`，`penalty_rate=1.000`

- 汇总统计（均值）：
  - `profit（利润）≈ 4,483.33`
  - `total_revenue（总收入）≈ 342,720.00`
  - `production_cost（生产成本）≈ 114,306.67`
  - `wage_cost（工资成本）≈ 183,100.00`
  - `penalty（罚金）= 40,830.00`（固定规则触发）
  - `utilization_rate（产线利用率）≈ 0.595`；`on_time_rate（准时率）= 0.000`；`penalty_rate（罚款触发率）= 1.000`

- 结论与下一步：
  - 在 7 天视野与当前订单设置下，GA 已能找到“轻度正利润”的解（受工资与生产成本限制、罚金固定），本次 VNS 未进一步超过 GA 的最优（控制台提示 `[VNS] 未找到更优邻域解`）。
  - 原因分析：短视野与固定到期分布下，“按期全部完成”的难度较高，罚金难以降至 0；VNS 的邻域以结构微调为主，若 GA 已较好地避开高工资槽，则进一步提升空间有限。
  - 下一步：按 `设计与实现方案.md` 的 5.6 节建议，在线性适应度中加入“截止/缓冲软罚项”，提高临近截止的加权，引导 GA+VNS 在更早槽保障关键订单；并在更长视野与更紧迫订单场景下评估 VNS 的收益（预计可降低 `penalty` 并提升 `on_time_rate`）。

> 复现提示：如需批量运行 3 个种子并自动汇总，可使用 `src/experiments/runner.py`（新增参数已转发）：
```
python -m src.experiments.runner \
  --exp_tag ga-vns \
  --seeds 404 405 406 \
  --horizon 7 --generations 150 --population 80 --crossover 0.8 --mutation 0.08 \
  --config data/config.json --orders data/orders.json --outdir results --runs_dir experiments \
  --local_search vns --ls_rounds 3 --ls_attempts 120
```

### 8.1 M3.1：截止软约束权重引导适应度（GA+VNS+SoftFitness）

- 目的：在不改变最终经济指标计算的前提下，用“截止软约束权重”引导 GA 的选择，鼓励在更早/低工资时段安排临近截止的产品，期望降低工资成本与过期风险。
- 代码接入：
  - `src/evaluation/fitness.py` 新增 `compute_soft_fitness(schedule, config, orders, alpha_deadline, beta_late_units, gamma_high_wage)`；以“截止接近度”“未按期单位数”“高工资活跃”三项构成软罚项，仅影响适应度分数，不改变输出的经济指标。
  - `src/algorithms/ga.py::run_ga(... use_soft_fitness, soft_alpha, soft_beta, soft_gamma)` 支持软适应度；
  - `src/main.py` 与 `src/experiments/runner.py` 新增 CLI 参数：`--soft_deadline --soft_alpha --soft_beta --soft_gamma`。

- 运行命令（样例，7 天视野、150 代，权重 `alpha=0.6, beta=0.25, gamma=0.0`）：
```
python -m src.main \
  --horizon 7 --generations 150 --pop 80 --pc 0.8 --pm 0.08 \
  --config data/config.json --orders data/orders.json --out results \
  --runs_dir experiments --exp_tag ga-vns-soft --seed 404 \
  --local_search vns --ls_rounds 3 --ls_attempts 120 \
  --soft_deadline --soft_alpha 0.6 --soft_beta 0.25 --soft_gamma 0.0
```

- 本次运行目录与关键指标（3 次不同种子）：
  - seed=404 → `experiments/run-20251110_145321_ga-vns-soft_seed404`
    - `profit=6,790.00`，`total_revenue=330,800.00`，`production_cost=109,880.00`，`wage_cost=173,300.00`，`penalty=40,830.00`
    - `utilization_rate=0.571`，`on_time_rate=0.000`，`penalty_rate=1.000`
  - seed=405 → `experiments/run-20251110_145345_ga-vns-soft_seed405`
    - `profit=4,510.00`，`total_revenue=320,840.00`，`production_cost=108,400.00`，`wage_cost=167,100.00`，`penalty=40,830.00`
    - `utilization_rate=0.556`，`on_time_rate=0.000`，`penalty_rate=1.000`
  - seed=406 → `experiments/run-20251110_145407_ga-vns-soft_seed406`
    - `profit=2,410.00`，`total_revenue=329,920.00`，`production_cost=109,280.00`，`wage_cost=177,400.00`，`penalty=40,830.00`
    - `utilization_rate=0.579`，`on_time_rate=0.000`，`penalty_rate=1.000`

- 汇总统计（均值，对比 M3 基线）：
  - `profit（利润）≈ 4,570.00`（较 M3 基线 ≈4,483.33，+1.93%）
  - `total_revenue（总收入）≈ 327,186.67`（较基线下降，趋向低工资时段生产）
  - `production_cost（生产成本）≈ 109,186.67`（较基线 ≈114,306.67，下降）
  - `wage_cost（工资成本）≈ 172,600.00`（较基线 ≈183,100.00，下降）
  - `penalty（罚金）= 40,830.00`（未变，受固定规则与短视野限制）
  - `utilization_rate（产线利用率）≈ 0.569`（较基线 ≈0.595，略降；体现“更谨慎安排”）
  - `on_time_rate（准时率）= 0.000`；`penalty_rate=1.000`（短视野/订单设置下仍难以达成“按期全部完成”）

- 结论：
  - 软适应度在当前 7 天视野下，整体倾向“低工资槽与更早安排”，显著降低工资与生产成本，尽管收入略降，但均值利润仍小幅提升。
  - 准时率未改善的主因是订单截止与可用时间分布在 7 天视野内过于紧张且惩罚规则固定，需延长视野或调整订单场景才能体现“截止权重”的充分作用。

- 下一步：
  - 在更长视野（如 14/30 天）与更紧迫订单场景中重复对比，观察 `on_time_rate` 与 `penalty` 的变化；
  - 根据企业情景微调权重（建议范围：`alpha∈[0.4,0.8]`，`beta∈[0.2,0.4]`，`gamma∈[0,0.2]`），并记录权重-效果曲线。

### 8.2 M3.1（扩展）：长视野对比（14/30 天，软适应度）

- 目的：在更长的计划视野下（14、30 天）检验软截止期引导是否能提高按时率与降低罚金，并观察成本与利润的变化。
- 代码接口：沿用 8.1 中的 `--soft_deadline --soft_alpha --soft_beta --soft_gamma`，GA 与 VNS 参数保持一致，仅调整 `--horizon` 与代数。

示例命令
- 14 天（3 种子）：
  - `python -m src.experiments.runner --exp_tag ga-vns-soft-h14 --seeds 404 405 406 --horizon 14 --generations 200 --population 80 --crossover 0.8 --mutation 0.08 --config data\\config.json --orders data\\orders.json --outdir results --runs_dir experiments --local_search vns --ls_rounds 3 --ls_attempts 120 --soft_deadline --soft_alpha 0.6 --soft_beta 0.25 --soft_gamma 0.0`
- 30 天（3 种子）：
  - `python -m src.experiments.runner --exp_tag ga-vns-soft-h30 --seeds 404 405 406 --horizon 30 --generations 300 --population 80 --crossover 0.8 --mutation 0.08 --config data\\config.json --orders data\\orders.json --outdir results --runs_dir experiments --local_search vns --ls_rounds 3 --ls_attempts 120 --soft_deadline --soft_alpha 0.6 --soft_beta 0.25 --soft_gamma 0.0`

实际运行目录
- 14 天：
  - `experiments/run-20251110_145831_ga-vns-soft-h14_seed404`
  - `experiments/run-20251110_145839_ga-vns-soft-h14_seed405`
  - `experiments/run-20251110_145847_ga-vns-soft-h14_seed406`
- 30 天：
  - `experiments/run-20251110_150016_ga-vns-soft-h30_seed404`
  - `experiments/run-20251110_145947_ga-vns-soft-h30_seed405`
  - `experiments/run-20251110_150018_ga-vns-soft-h30_seed406`
  - 批量汇总：`experiments/batch_ga-vns-soft-h14_summary.csv`，`experiments/batch_ga-vns-soft-h30_summary.csv`

核心指标（来自各运行目录的 `metrics.json`）
- 14 天（404/405/406）：
  - 利润：-86270 / -99450 / -89730（平均 -91816.67）
  - 收入：408300（恒定）
  - 生产成本：171840 / 170920 / 173200（平均 171986.67）
  - 工资成本：281900 / 296000 / 284000（平均 287300）
  - 罚款：40830（恒定）
  - 产线利用率：0.4683 / 0.4841 / 0.4683（平均 ≈0.474）
  - 按时完成率：0.0；触发罚款比例：1.0
- 30 天（404/405/406）：
  - 利润：-675110 / -684170 / -661250（平均 -673510）
  - 收入：408300（恒定）
  - 生产成本：383080 / 381040 / 377320（平均 380480）
  - 工资成本：659500 / 670600 / 651400（平均 660500）
  - 罚款：40830（恒定）
  - 产线利用率：0.5019 / 0.5056 / 0.4963（平均 ≈0.501）
  - 按时完成率：0.0；触发罚款比例：1.0

对比与结论
- 与 7 天视野相比，在 14/30 天视野下按时率仍为 0，罚金比例仍为 1.0，说明当前订单截止日设置与产能约束组合下，即便全部产量完成也普遍晚于截止期。
- 工资成本随视野显著增长（尤其 30 天），导致利润为负；软适应度降低了不必要的高工资工时的能力有限，主要受限于现有排班成本模型的时间跨度累计。
- 产线利用率在长视野略升（约 0.47 → 0.50），但不足以弥补工资与罚金对利润的冲击。

后续建议
- 业务参数校准：
  - 截止期设定与订单集（更高紧急度）需与长视野匹配，否则“按时率”难改善。
  - 工资成本模型需明确是否按日固定/按班次计费，避免长视野下线性累计导致利润系统性为负。
- 软适应度权重探索：尝试提高 `alpha`（截止期压力）与引入对“提前交付”奖励项，降低 `beta`（高工资项）在长视野的放大效应。
- 算法层面：在 VNS 中加入“提前交付优先”的邻域策略，配合软适应度更有效地拉近交付至截止日前。
## 8.3 M6 阶段2：三场景×30次批量运行与统计

目的：完成低/中/高工资三场景下，三算法（GA、GA+VNS、GA+VNS+SA）的30次重复，并计算均值±标准差。

批量命令（seed=500..529）：
```
# GA
python -m src.experiments.runner --exp_tag ga-only-m6s2 \
  --horizon 7 --generations 60 --population 50 --crossover 0.8 --mutation 0.08 \
  --scenarios wage-low wage-medium wage-high --append_scenario_to_tag \
  --seed-start 500 --seed-end 529

# GA+VNS
python -m src.experiments.runner --exp_tag ga-vns-m6s2 \
  --horizon 7 --generations 60 --population 50 --crossover 0.8 --mutation 0.08 \
  --local_search vns --ls_rounds 3 --ls_attempts 120 \
  --scenarios wage-low wage-medium wage-high --append_scenario_to_tag \
  --seed-start 500 --seed-end 529

# GA+VNS+SA
python -m src.experiments.runner --exp_tag ga-vns-sa-m6s2 \
  --horizon 7 --generations 60 --population 50 --crossover 0.8 --mutation 0.08 \
  --local_search vns --ls_rounds 3 --ls_attempts 120 \
  --sa_initial_temp 800 --sa_cooling 0.95 --sa_moves_per_temp 300 --sa_temps 30 \
  --scenarios wage-low wage-medium wage-high --append_scenario_to_tag \
  --seed-start 500 --seed-end 529
```

统计脚本：`experiments/scripts/compute_m6s2_averages.py`
- 功能：读取三场景的汇总CSV，按seed去重（保留最后一行），输出均值±标准差。
- 用法：`python experiments/scripts/compute_m6s2_averages.py`

统计结果（三场景×30次，均值±标准差）：
- 低工资（wage-low）
  - GA：`profit=13178.67 ± 3644.85`，`util=0.6513 ± 0.0418`，`on_time=0.004 ± 0.023`，`penalty_rate=0.996 ± 0.023`
  - GA+VNS：`profit=13010.67 ± 3515.98`，`util=0.6548 ± 0.0435`，`on_time=0.004 ± 0.023`，`penalty_rate=0.996 ± 0.023`
  - GA+VNS+SA：`profit=13567.33 ± 3114.20`，`util=0.6421 ± 0.0371`，`on_time=0.013 ± 0.038`，`penalty_rate=0.988 ± 0.038`
- 中工资（wage-medium）
  - GA：`profit=2618.67 ± 3589.32`，`util=0.6063 ± 0.0336`，`on_time=0.013 ± 0.038`，`penalty_rate=0.988 ± 0.038`
  - GA+VNS：`profit=2751.33 ± 3853.12`，`util=0.6087 ± 0.0339`，`on_time=0.008 ± 0.032`，`penalty_rate=0.992 ± 0.032`
  - GA+VNS+SA：`profit=2235.33 ± 3707.21`，`util=0.6029 ± 0.0368`，`on_time=0.008 ± 0.032`，`penalty_rate=0.992 ± 0.032`
- 高工资（wage-high）
  - GA：`profit=-8508.00 ± 3444.18`，`util=0.5463 ± 0.0326`，`on_time=0.004 ± 0.023`，`penalty_rate=0.996 ± 0.023`
  - GA+VNS：`profit=-8586.00 ± 3655.40`，`util=0.5505 ± 0.0346`，`on_time=0.004 ± 0.023`，`penalty_rate=0.996 ± 0.023`
  - GA+VNS+SA：`profit=-7972.00 ± 3648.58`，`util=0.5468 ± 0.0312`，`on_time=0.004 ± 0.023`，`penalty_rate=0.996 ± 0.023`

结论（本轮）：
- GA 与 GA+VNS 的均值接近，SA 在低/高工资场景的利润略优；中工资场景下三者接近。
- 准时率与罚金触发率显示当前订单截止分布较紧且软约束不足；后续建议在`runner`中加软截止引导权重或扩展“订单紧迫度”场景进行更细致评估。

图表（输出路径：`paper/figures/`）：
- `m6s2_profit_box_by_scenario.png`：三算法在低/中/高工资场景的利润分布（箱线图）。
- `m6s2_utilization_rate_bars_by_scenario.png`：产线利用率均值±标准差（条形图）。
- `m6s2_on_time_rate_bars_by_scenario.png`：准时率均值±标准差（条形图）。
- `m6s2_penalty_rate_bars_by_scenario.png`：罚金触发率均值±标准差（条形图）。