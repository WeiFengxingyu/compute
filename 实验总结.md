# 实验总结（M0–M6 与阶段2.1）

本文面向非技术听众与技术读者的混合场景，系统性总结我们在离散制造排产问题上的实验过程、关键结论、局限与改进方向。专业术语统一给出中文与英文，并附简要解释。

---

## 一、研究背景与目标

- 问题：在给定的生产线与时段资源下，为不同产品安排生产，以尽量满足订单到期（按时交付），同时最大化利润并控制加班与罚金。
- 主要评价指标：
  - 利润（profit）：总收入减去生产成本与罚金。
  - 利用率（utilization rate）：生产线在可用时段内的实际使用比例。
  - 准时率（on-time rate）：按到期时间完成的订单占比。
  - 罚金触发率（penalty rate）：因延迟而产生罚金的订单占比。

---

## 二、术语与方法简释

- 基线（baseline）：最小可用的算法版本，用来建立后续改进的参照。
- 解码器（decoder）：将算法内部的“解”（如遗传算法中的染色体或状态）转换成具体的生产排程（每条生产线、每个时段生产哪种产品、产量多少）。我们采用“最早到期优先（Earliest Due Date，EDD）+ 利润密度（单位时间或单位容量的利润）”的启发式策略，优先安排接近到期且更“划算”的产品。
- 遗传算法（Genetic Algorithm，遗传算法）：通过选择、交叉、变异等操作在解空间中搜索，兼顾探索与继承优良结构。
- 变邻域搜索（Variable Neighborhood Search，变邻域搜索）：在当前解附近通过不同规模的“邻域”进行改良（如小范围产品交换、中等跨线产量重分配、大范围时间块滑移）。
- 迭代局部搜索（Iterated Local Search，迭代局部搜索）：在多个局部最优之间跳转以寻找更好解，常与变邻域搜索一起讨论。
- 模拟退火（Simulated Annealing，模拟退火）：通过“以一定概率接受变差解”的机制，避免陷入局部最优；温度逐步降低，探索从大步到小步。
- 禁忌搜索（Tabu Search，禁忌搜索）：通过维护“禁忌表”，暂时禁止近期操作，避免回到旧解或陷入循环。（已规划，暂缓实现）
- 软截止引导（soft deadline guidance，软截止）：在评价或决策中加入“软性惩罚/奖励”，鼓励尽早完工，但不强制约束；用参数（如 `h14`、`h30`）控制引导强度或作用窗口。
- 随机种子（random seed，随机种子）：控制随机过程的初始状态，用于复现实验。
- 消融（ablation，消融）：去除或改变某一模块/参数，观察指标变化，评估该模块的影响。

---

## 三、算法版本线与模块

- 基线：遗传算法 + 解码器（EDD + 利润密度），适应度计算利润与核心指标。
- 遗传算法增强：强化交叉与变异策略、加入可行性修复（如避免高工资时段盲目启动，优先白天时段）。
- 局部搜索集成：将变邻域搜索/迭代局部搜索挂在解码器之后，对排程做精修（小/中/大三类邻域）。
- 二次优化：接入模拟退火（温度层数、每温度移动次数、降温系数可配置）；禁忌搜索预留。
- 对比算法计划：粒子群优化（Particle Swarm Optimization，粒子群）与蚁群优化（Ant Colony Optimization，蚁群），作为论文的进一步对比或未来工作。

---

## 四、实验设置与场景

- 工资系数场景（低/中/高）：通过时段工资系数控制“白天/夜间”成本差异，检验算法在成本结构变化下的鲁棒性。
- 算法组合：
  - 遗传算法（GA）
  - 遗传算法 + 变邻域搜索（GA+VNS）
  - 遗传算法 + 变邻域搜索 + 模拟退火（GA+VNS+SA）
- 运行规模：每场景 × 每算法 30 次独立运行（固定种子集合），生成汇总 CSV 与图表。
- 软截止参数消融：`h14` vs `h30` 两种设置的对比。
- 数据与脚本：
  - 汇总 CSV：`experiments/batch_ga-only-m6s2-wage-{low,medium,high}_summary.csv`、`experiments/batch_ga-vns-m6s2-wage-{low,medium,high}_summary.csv`、`experiments/batch_ga-vns-sa-m6s2-wage-{low,medium,high}_summary.csv`
  - 软截止 CSV：`experiments/batch_ga-vns-soft-h14_summary.csv`、`experiments/batch_ga-vns-soft-h30_summary.csv`
  - 绘图脚本：`experiments/scripts/plot_m6s2_figures.py`、`experiments/scripts/plot_soft_ablation_figures.py`
  - 统计脚本：`experiments/scripts/compute_m6s2_tests.py`

---

## 五、实验过程与每步简述（M0–M6、阶段2.1）

- M0 基础设施与规范：
  - 目标：搭建可复现的实验环境与留痕体系。
  - 做法：目录结构、命令行入口、实验运行记录器，自动落盘配置、订单、排程、指标与摘要。
  - 结论：通路稳定，复现性良好。

- M1 基线（遗传算法 + 解码器 + 适应度评估）：
  - 目标：建立最小可用版本，输出稳定排程与指标。
  - 做法：EDD+利润密度解码器，适应度评估包含利润与核心指标；多次独立运行观察收敛趋势。
  - 结论：利润与利用率趋势稳定；准时率总体偏低，是后续优化重点。

- M2 遗传算法增强：
  - 目标：提升结构继承与解的多样性，减少不合理启动。
  - 做法：块交叉、分层变异、可行性修复（避开高工资时段盲目启动）。
  - 结论：利润在部分场景有小幅提升，准时与罚金改善不明显。

- M3 局部搜索集成（变邻域搜索 / 迭代局部搜索）：
  - 目标：对基线排程进行精修。
  - 做法：三类邻域（小/中/大），与遗传算法串联。
  - 结论：平均表现与基线接近，个别运行有改良；说明准时与罚金的结构性难题仍在。

- M4 二次优化（模拟退火，禁忌搜索预留）：
  - 目标：通过受控接受“变差解”避免局部最优、探索更佳解。
  - 做法：自动估计初温；配置温度层数、每温度移动次数、降温系数。
  - 结论：利润在部分场景有改善但不稳定；对准时或罚金未形成显著提升。

- M6 批量实验与核心对比（3 场景 × 3 算法 × 30 次）：
  - 目标：获得稳健的平均表现与统计结论。
  - 做法：固定种子集合；生成汇总 CSV 与图表。
  - 图表（已生成至 `paper/figures`）：
    - `m6s2_profit_box_by_scenario.png`
    - `m6s2_utilization_rate_bars_by_scenario.png`
    - `m6s2_on_time_rate_bars_by_scenario.png`
    - `m6s2_penalty_rate_bars_by_scenario.png`
  - 统计检验：配对 t 检验（差值均值 Δ、t 统计量、双侧 p 值），摘要见 `paper/figures/m6s2_ttests_summary.md`。
  - 结论（易懂版）：
    - 遗传算法与“遗传算法 + 变邻域搜索”整体表现接近；
    - “模拟退火”的利润提升具有场景依赖：在高工资场景有边缘性改善（p≈0.088），整体未达到普遍显著；
    - 准时率总体偏低，软性改良（如仅用模拟退火）对提升准时或降低罚金的效果有限；
    - 在低工资场景，模拟退火相对变邻域搜索的利用率显著略低（小幅负向，p≈0.046）。

- M6 阶段2.1：软截止引导参数消融（`h14` vs `h30`）
  - 目标：检验不同软截止参数对四项指标的影响。
  - 做法：读取 `h14/h30` 汇总 CSV，生成对比条形图；脚本移除第三方依赖，保证可运行。
  - 图表：
    - `m6s2_soft_profit_bars.png`
    - `m6s2_soft_utilization_rate_bars.png`
    - `m6s2_soft_on_time_rate_bars.png`
    - `m6s2_soft_penalty_rate_bars.png`
  - 结论：
    - `h14` 在利润上优于 `h30`；
    - 准时率与罚金触发率基本未改善或变化不明显；
    - 单独使用软截止引导不足以显著提升准时或减罚金，需要更强的期限权重与调度策略配合。

---

## 六、结果总览与统计摘要（配对 t 检验）

- 方法说明：在相同种子（同一数据与随机初始条件）下比较两个算法的差异，计算“差值均值（Δ）”、t 统计量与双侧 p 值；若 `p < 0.05`，视为显著差异。
- 文件：`paper/figures/m6s2_ttests_summary.md`（按场景与指标列出 `n/Δ/t/p`）。
- 关键信息（提要）：
  - 多数场景与指标下，算法之间差异“不显著”（p 大多 > 0.05），说明总体表现相近；
  - 高工资场景下，“模拟退火”在利润方面有边缘性改善（未达显著阈值）；
  - 低工资场景中，“模拟退火”相对“变邻域搜索”的利用率显著略低（p≈0.046）。

---

## 七、问题与解决方案：如何提升“准时率（on-time rate）”

### 1) 目标函数加权与软罚系数调优
- 将期限相关的权重（deadline weight）加大，引入/增大软罚（soft penalty）系数，让迟交的代价在适应度中更“痛”。
- 常用做法：在适应度中加入“迟交惩罚（tardiness penalty）”或“延迟成本（lateness cost）”，并设定较高权重；同时控制生产成本与利润权衡，避免“为准时率而过度牺牲利润”。

### 2) 启发式策略强化（与解码器结合）
- 组合启发式：最早到期优先（EDD）+ 最短加工时间（SPT）+ 最小剩余裕度（Least Slack）；在同等利润密度下优先安排“更紧迫”订单。
- 动态优先级：根据“距离截止时间”的实时变化，逐步提高紧迫订单的调度优先级。

### 3) 局部搜索的期限感知动作
- 邻域设计向“挪动到更早时段/更低成本且能保准时”倾斜，例如：
  - 紧迫订单块右移/左移的受限滑移（避免打散导致产能碎片化）；
  - 跨线再分配：在不显著降低利润的前提下，给紧迫订单更多产能；
  - 预留机制：给临近到期订单预留时段，减少被后续高利润订单挤占的风险。

### 4) 算法对比（粒子群优化、蚁群优化）
- 粒子群优化（PSO，Particle Swarm Optimization）：
  - 思路：将“每线-每时段的产量比例与产品选择概率”连续化，粒子在连续空间搜索；解码器保持一致，期限权重与软罚直接注入适应度。
  - 要点：速度/位置更新、约束处理（比例归一化、产能限制）、启发式初始化（按 EDD/Slack 预偏置）。
- 蚁群优化（ACO，Ant Colony Optimization）：
  - 思路：构造“时段-产品序列”，信息素奖励“早完工（按时）与高利润密度”，蒸发系数与启发项调优。
  - 要点：信息素更新策略、防止循环与死路、对期限与产能的约束修复。
- 对比实验建议（可选加强版）：
  - 三场景 × 两算法（PSO、ACO）× 10 次；与 GA/GA+VNS/GA+VNS+SA 对比，指标同上；
  - 重点观察准时率与罚金触发率的显著性变化，同时记录利润变化。

### 5) 滚动重排与在线策略（若允许）
- 在订单到来或状态变化时触发局部重排（rescheduling），把临近到期订单向前推进；
- 引入“冻结窗口与滚动窗口”，保持已排定的近期时段稳定，同时在更远时段适应性调整。

---

## 八、什么是“软截止引导消融”？

- 定义：
  - 软截止引导（soft deadline guidance）：在决策或评估中引入“软性惩罚/奖励”，鼓励更早完成订单，但不做硬性约束（不是强制必须在截止前完成）。
  - 消融（ablation）：对某一模块或参数做对比实验，观察对指标的影响，评估其贡献。
- 我们的设置：
  - `h14` vs `h30` 表示两种“软截止引导强度或作用窗口”的参数设置（例如在 14 时段 vs 30 时段的引导或不同权重规模），对同一算法（遗传算法 + 变邻域搜索）进行对比。
- 结论：
  - `h14` 在利润上优于 `h30`；
  - 对准时率与罚金触发率，单独的软截止引导作用有限（未形成显著提升）。
  - 解释：软引导提供“早做更好”的趋势，但若目标函数中期限权重不够强、或调度策略未显著为紧迫订单让路，最终对准时与罚金的改善就有限。

---

## 九、材料与复现

- 图表（论文用，路径 `paper/figures`）：
  - 场景对比：`m6s2_profit_box_by_scenario.png`、`m6s2_utilization_rate_bars_by_scenario.png`、`m6s2_on_time_rate_bars_by_scenario.png`、`m6s2_penalty_rate_bars_by_scenario.png`
  - 软截止消融：`m6s2_soft_profit_bars.png`、`m6s2_soft_utilization_rate_bars.png`、`m6s2_soft_on_time_rate_bars.png`、`m6s2_soft_penalty_rate_bars.png`
  - 统计摘要：`m6s2_ttests_summary.md`
- 汇总 CSV（路径 `experiments/`）：
  - `batch_ga-only-m6s2-wage-{low,medium,high}_summary.csv`
  - `batch_ga-vns-m6s2-wage-{low,medium,high}_summary.csv`
  - `batch_ga-vns-sa-m6s2-wage-{low,medium,high}_summary.csv`
  - `batch_ga-vns-soft-h14_summary.csv`、`batch_ga-vns-soft-h30_summary.csv`
- 核心脚本（路径 `experiments/scripts/`）：
  - `plot_m6s2_figures.py`（场景对比图）
  - `plot_soft_ablation_figures.py`（软截止消融图）
  - `compute_m6s2_tests.py`（配对 t 检验摘要）
- 运行留痕：`experiments/run-YYYYMMDD_HHMMSS_<tag>_seed<SEED>/`（含配置、订单、排程、指标与摘要）。

---

## 十、实验冻结与论文撰写建议

- 冻结点：M6 阶段2的核心对比与统计检验已完成；“软截止消融”初步结论明确；进入论文撰写（M7）。
- 论文章节建议：
  - 实验设置（场景、算法、重复次数与指标的解释与中文标注）；
  - 图表：利润箱线图、利用率/准时率/罚金条形图；
  - 统计方法：配对 t 检验（p 值与显著性阈值）；

## M8 阶段：不同订单紧迫度场景对比实验（统计与图表已更新）

### 实验设计
- **目的**：评估不同订单紧迫度场景下各算法的表现差异
- **场景设置**：
  - 宽松场景(loose)：平均交付期限2.9天，订单时间压力较小
  - 中等场景(medium)：平均交付期限1.4天，平衡的时间压力
  - 紧张场景(tight)：平均交付期限1.4天，但更早到期，时间压力最大
- **算法对比**：GA、GA-VNS、GA-VNS-SA、PSO
- **实验规模**：3场景 × 4算法 × 30次 = 360次独立实验
- **数据生成**：使用`src/data/scenario_generator.py`自动生成各场景数据

### 当前进展（2025-01-02 更新）
- ✅ 场景数据生成完成：`data/scenarios/` 目录下包含所有场景的配置和订单文件
- ✅ 批量运行结果已聚合：生成各算法×场景的 `batch_*_summary.csv`
- ✅ 统计与图表已更新：`experiments/m8_plots/` 下已保存四张对比图与总结表

### 数据位置与同步
- 汇总表：`experiments/m8_plots/m8_summary_table.md`
- 图表：`experiments/m8_plots/m8_profit_comparison.png`、`m8_utilization_comparison.png`、`m8_on_time_rate_comparison.png`、`m8_radar_comparison.png`
- 原始批量 CSV：`experiments/batch_ga-*-m6s3_summary.csv`、`experiments/batch_ga-vns-*-m6s3_summary.csv`、`experiments/batch_ga-vns-sa-*-m6s3_summary.csv`、`experiments/batch_pso-*-m6s3_summary.csv`

### 结论快照（以总结表为准）
- 三场景均已统计 30 次/算法；均值±标准差与样本数见 `m8_summary_table.md`
- MEDIUM 场景下，GA+VNS+SA 在四项指标上总体优于 GA/GA+VNS；PSO 的准时率较高但利润较低（当前参数设置下）
- LOOSE 场景下，PSO 利润最高；GA+VNS+SA 在利用率与准时率上表现更优
- TIGHT 场景下，PSO 的准时率明显高于 GA/GA+VNS/GA+VNS+SA，但利润偏低

### PSO 随机种子与重跑说明
- 种子注入：在 `src/main.py` 已调用 `random.seed(args.seed)`，PSO 使用 `random.uniform/random.random` 进行初始化与更新，已受 `--seed` 控制；批量运行器会传入不同种子。
- 观察到 MEDIUM/TIGHT 场景下 PSO 的标准差为 0：这更可能来源于解码与目标函数在当前参数下达到同一全局最优（或强势唯一最优），而不是“未使用种子”。
- 若你计划增强 PSO 的随机性（如在优先级或吸引度排序中加入微小随机抖动，或调整 `w/c1/c2/max_vel` 以扩大搜索空间），则仅需重跑 PSO 的三场景×30 次即可，无需重做 GA/GA+VNS/GA+VNS+SA。
- 重跑后：执行 `experiments/scripts/aggregate_m8_batches.py` → `compute_m8_averages.py` → `plot_m8_figures.py`，自动同步到总结表与图表。

### 预期分析
- 对比不同算法在各紧迫度场景下的：
  - 利润表现（profit）
  - 准时交付率（on-time rate）
  - 产线利用率（utilization rate）
  - 罚金触发率（penalty rate）
- 分析算法对订单紧迫度的敏感性和适应性
- 为实际生产调度提供算法选择建议
  - 结论与局限：模拟退火的利润提升具场景依赖；准时率整体偏低的系统性成因；
  - 改进方向：期限权重调优、启发式强化、本地搜索的期限感知动作、PSO/ACO 对比计划、滚动重排机制。

---

## 十一、最终要点（易懂版）

- 在我们当前设定下：
  - 遗传算法与变邻域搜索的平均表现差异不大；
  - 模拟退火能在部分场景提升利润，但对“按时交付”和“减少罚金”的帮助有限；
  - `h14` 的软截止引导比 `h30` 更有利于利润，但不足以显著改善准时或罚金；
  - 要显著提升准时率，需要更强的期限权重、更“期限感知”的调度动作，或引入粒子群/蚁群等对比算法以寻找更优的时间分配策略。

---

## M8 数值摘要与显著性（同步）

- 样本规模：每算法每场景 n=30；均值±标准差来自 `experiments/scripts/compute_m8_averages.py`；显著性为“与 GA 的配对 t 检验”，来自 `experiments/scripts/compute_m8_tests.py`（ns: 不显著；*: p<0.05；***: p<0.001）。

- LOOSE 场景：
  - GA：`profit=-39050.33±8135.48`，`util=0.65±0.04`，`on_time=0.33±0.10`，`penalty=0.67±0.10`
  - GA+VNS：`profit=-41824.67±7501.53`，`util=0.64±0.05`，`on_time=0.34±0.12`，`penalty=0.66±0.12`
  - GA+VNS+SA：`profit=38454.43±14191.17`，`util=0.91±0.03`，`on_time=0.62±0.06`，`penalty=0.38±0.06`
  - PSO：`profit=75926.10±3134.79`，`util=0.80±0.01`，`on_time=0.63±0.04`，`penalty=0.37±0.04`
  - 显著性（相对 GA）：利润/利用率/准时率/罚金率均对 GA+VNS+SA 与 PSO 显著（p=0.000***）；GA+VNS 多数指标不显著。
  - 结论：PSO 利润显著最高并兼具较高准时；GA+VNS+SA 利用率显著最高且准时显著提升。

- MEDIUM 场景：
  - GA：`profit=2422.67±3807.17`，`util=0.60±0.03`，`on_time=0.01±0.03`，`penalty=0.99±0.03`
  - GA+VNS：`profit=2454.00±3919.19`，`util=0.61±0.03`，`on_time=0.01±0.03`，`penalty=0.99±0.03`
  - GA+VNS+SA：`profit=4930.67±5552.44`，`util=0.63±0.08`，`on_time=0.07±0.14`，`penalty=0.93±0.14`
  - PSO：`profit=-12093.00±0.00`，`util=0.49±0.00`，`on_time=0.25±0.00`，`penalty=0.75±0.00`
  - 显著性（相对 GA）：PSO 在四项指标均显著（p=0.000***，准时/罚金提升但利润与利用率下降）；GA+VNS+SA 在利润/利用率/准时/罚金均有小幅显著（p≈0.014–0.041*）。
  - 结论：若以准时/减罚为主要目标，PSO 更优；若兼顾利润与利用率，GA+VNS+SA 较 GA 有小幅显著提升。

- TIGHT 场景：
  - GA：`profit=-17978.67±4614.08`，`util=0.49±0.04`，`on_time=0.01±0.03`，`penalty=0.99±0.03`
  - GA+VNS：`profit=-19858.33±4465.85`，`util=0.48±0.05`，`on_time=0.01±0.03`，`penalty=0.99±0.03`
  - GA+VNS+SA：`profit=-2498.27±13505.06`，`util=0.68±0.13`，`on_time=0.07±0.04`，`penalty=0.93±0.04`
  - PSO：`profit=-33856.00±0.00`，`util=0.42±0.00`，`on_time=0.25±0.00`，`penalty=0.75±0.00`
  - 显著性（相对 GA）：GA+VNS+SA 与 PSO 在四项指标均显著（p=0.000***），方向为“准时提升、罚金降低”；PSO 利润显著更低。
  - 结论：在最紧迫场景下，PSO 的准时率最高但牺牲利润；GA+VNS+SA 在利润与利用率上显著优于 GA，同时提升准时。

备注：MEDIUM/TIGHT 场景中 PSO 的标准差为 0，源于当前参数与解码下的稳定（或唯一）最优；与随机种子无关。若调整 PSO 的随机性或参数，仅需重跑 PSO 的三场景×30 次并重新聚合与统计。